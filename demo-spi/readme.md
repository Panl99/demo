SPI(Service Provider Interface)

java内置的服务发现机制

## 作用
将服务接口 和服务实现分离，达到解耦、提升程序可扩展的机制。

可以用来被第三方实现或者扩展的接口。

在运行时动态的为接口替换实现类，实现服务热插拔。

### 缺点

- 虽然ServiceLoader也算是使用的延迟加载，但是基本只能通过遍历全部获取，也就是接口的实现类全部加载并实例化一遍。如果你并不想用某些实现类，它也被加载并实例化了，这就造成了浪费。获取某个实现类的方式不够灵活，只能通过Iterator形式获取，不能根据某个参数来获取对应的实现类。

- 多个并发多线程使用ServiceLoader类的实例是不安全的。


## SPI四个重要组件

- 服务接口：一个定义了服务提供者实现类契约方法的接口或者抽象类。
- 服务实现：实际提供服务的实现类。
- 配置文件：文件名必须存在于 META-INF/services 目录中。文件名应与服务提供商接口完全限定名完全相同。文件中的每一行都有一个实现服务类详细信息，即服务提供者类的完全限定名。
- 服务加载：ServiceLoader： Java SPI 关键类，用于加载服务提供者接口的服务。ServiceLoader 中有各种实用程序方法，用于获取特定的实现、迭代它们或再次重新加载服务。


## 常见Java-SPI使用场景

- JDBC 加载不同类型数据库的驱动
- SLF4J 加载不同提供商的日志实现类：logback、log4j、log4j2
- Spring 中大量使用了 SPI：自动类型转换Type Conversion SPI(Converter SPI、Formatter SPI)
- dubbo 自己实现的 SPI 加载机制，许用户扩展实现Filter接口

## SPI、API

API：由实现方定制接口，并完成对接口的实现，调用方仅依赖接口调用，且无权选择不同实现。从使用人员上来说，API被应用开发人员使用。

SPI：由调用方来制定接口规范，提供给外部实现，调用方在调用时选择自己需要的外部实现。从使用人员上来说，SPI被框架扩展人员使用。